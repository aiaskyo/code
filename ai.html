<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Askyo Chat - Powered by Gemini</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* CSS poora same rahega, yahan jagah bachane ke liye nahi daal raha */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .chat-container { background: rgba(255, 255, 255, 0.95); border-radius: 20px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1); width: 100%; max-width: 900px; height: 80vh; display: flex; flex-direction: column; overflow: hidden; backdrop-filter: blur(10px); }
        .header { background: linear-gradient(135deg, #4285f4 0%, #34a853 50%, #fbbc05 75%, #ea4335 100%); color: white; padding: 20px; text-align: center; position: relative; }
        .header h1 { font-size: 1.8rem; font-weight: 600; margin-bottom: 5px; }
        .header p { font-size: 0.9rem; opacity: 0.9; }
        .clear-button { position: absolute; top: 20px; right: 20px; background: rgba(255, 255, 255, 0.2); color: white; border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-size: 0.9rem; transition: background 0.3s ease; }
        .clear-button:hover { background: rgba(255, 255, 255, 0.3); }
        .chat-messages { flex: 1; overflow-y: auto; padding: 20px; background: #f8f9fa; }
        .message { margin-bottom: 20px; display: flex; align-items: flex-start; animation: fadeIn 0.5s ease-in; }
        .message.user { justify-content: flex-end; }
        .message.bot { justify-content: flex-start; }
        .message-content { max-width: 70%; padding: 15px 20px; border-radius: 18px; position: relative; word-wrap: break-word; }
        .message.user .message-content { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-bottom-right-radius: 5px; }
        .message.bot .message-content { background: white; color: #333; border: 1px solid #e9ecef; border-bottom-left-radius: 5px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); }
        .message-avatar { width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 10px; font-size: 1.2rem; flex-shrink: 0; }
        .message.user .message-avatar { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; order: 1; }
        .message.bot .message-avatar { background: linear-gradient(135deg, #4285f4 0%, #34a853 50%, #fbbc05 75%, #ea4335 100%); color: white; }
        .message-avatar i { line-height: 0; }
        .input-section { padding: 20px; background: white; border-top: 1px solid #e9ecef; }
        .input-form { display: flex; gap: 10px; align-items: center; }
        .message-input { flex: 1; padding: 15px 20px; border: 2px solid #e9ecef; border-radius: 25px; font-size: 1rem; outline: none; transition: border-color 0.3s ease; }
        .message-input:focus { border-color: #667eea; }
        .send-button { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; width: 50px; height: 50px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; }
        .send-button:hover { transform: scale(1.05); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        .send-button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; background: #aaa; }
        .loading-dots { display: flex; gap: 5px; }
        .loading-dot { width: 8px; height: 8px; border-radius: 50%; background: #667eea; animation: bounce 1.4s infinite ease-in-out both; }
        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }
        .error-message { background: #f8d7da; color: #721c24; padding: 15px; border-radius: 10px; margin: 10px 0; border: 1px solid #f5c6cb; }
        .info-message { background: #d1ecf1; color: #0c5460; padding: 15px; border-radius: 10px; margin: 10px 0; border: 1px solid #bee5eb; }
        pre { background: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 8px; overflow-x: auto; margin: 10px 0; font-family: 'Courier New', Courier, monospace; font-size: 0.9rem; }
        code { background: #eee; padding: 2px 4px; border-radius: 3px; font-family: 'Courier New', Courier, monospace; }
        pre code { background: none; padding: 0; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="header">
            <h1><i class="fa-solid fa-robot"></i> AI Askyo</h1>
            <p>Your intelligent assistant powered by Gemini</p>
            <button class="clear-button" id="clearChatBtn">
                <i class="fa-solid fa-trash"></i> Clear Chat
            </button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="info-message">
                <strong>Welcome to AI Askyo!</strong><br>
                Start typing below to chat with the AI.
            </div>
        </div>
        <div class="input-section">
            <form class="input-form" id="messageForm">
                <input type="text" class="message-input" id="messageInput" placeholder="Type your message here..." autocomplete="off">
                <button type="submit" class="send-button" id="sendButton">
                    <i class="fa-solid fa-paper-plane"></i>
                </button>
            </form>
        </div>
    </div>

    <script>
        class GeminiChat {
            constructor() {
                this.apiKey = 'AIzaSyCqozDGBvhjJHznMLcG45BQyhvR7SBRGqw';
                this.model = 'gemini-1.5-flash';
                this.conversationHistory = [];
                this.isLoading = false;
                
                this.initializeElements();
                this.setupEventListeners();
            }

            initializeElements() {
                this.chatMessages = document.getElementById('chatMessages');
                this.messageInput = document.getElementById('messageInput');
                this.sendButton = document.getElementById('sendButton');
                this.messageForm = document.getElementById('messageForm');
                this.clearChatBtn = document.getElementById('clearChatBtn');
            }

            setupEventListeners() {
                this.messageForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.sendMessage();
                });
                this.clearChatBtn.addEventListener('click', () => this.clearChat());
            }

            // ===== YEH FUNCTION NAYA HAI (THIS FUNCTION IS NEW) =====
            async retryWithBackoff(apiCallFunction, maxRetries = 3) {
                let delay = 2000; // Start with a 2-second delay
                for (let i = 0; i < maxRetries; i++) {
                    try {
                        const result = await apiCallFunction();
                        return result; // Agar successful, to result return karo
                    } catch (error) {
                        // Agar error 'overloaded' ya '503' (server unavailable) hai tabhi retry karo
                        if (error.message.includes("overloaded") || error.message.includes("503")) {
                            if (i < maxRetries - 1) {
                                console.log(`Attempt ${i + 1} failed. Retrying in ${delay / 1000} seconds...`);
                                await new Promise(resolve => setTimeout(resolve, delay));
                                delay *= 2; // Delay ko double karo
                            } else {
                                // Aakhri try ke baad bhi fail hua to error throw karo
                                throw new Error("The model is still overloaded after several retries. Please try again later.");
                            }
                        } else {
                            // Koi aur error hai to turant throw karo
                            throw error;
                        }
                    }
                }
            }

            // ===== SENDMESSAGE FUNCTION MEIN BADLAV (CHANGES IN SENDMESSAGE) =====
            async sendMessage() {
                const messageText = this.messageInput.value.trim();
                if (!messageText || this.isLoading) return;

                this.addMessage(messageText, 'user');
                this.conversationHistory.push({ role: 'user', parts: [{ text: messageText }] });
                this.messageInput.value = '';
                this.setLoading(true);

                try {
                    // Ab hum seedhe API call nahi karenge, balki retry function ke through karenge
                    const apiCall = () => this.callGeminiAPI();
                    const responseText = await this.retryWithBackoff(apiCall);

                    this.addMessage(responseText, 'bot');
                    this.conversationHistory.push({ role: 'model', parts: [{ text: responseText }] });
                } catch (error) {
                    this.showError(`API Error: ${error.message}`);
                    this.conversationHistory.pop(); // Failed attempt ko history se hata do
                } finally {
                    this.setLoading(false);
                }
            }

            async callGeminiAPI() {
                const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${this.model}:generateContent?key=${this.apiKey}`;
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: this.conversationHistory })
                });

                if (!response.ok) {
                    // HTTP 503 Service Unavailable bhi 'overloaded' jaisa hi hai
                    if (response.status === 503) {
                        throw new Error("503: Service Unavailable (overloaded)");
                    }
                    const errorData = await response.json().catch(() => ({}));
                    const errorMessage = errorData.error?.message || `HTTP Error ${response.status}`;
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                
                if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                    return data.candidates[0].content.parts[0].text;
                } else {
                    let reason = data.candidates?.[0]?.finishReason || "UNKNOWN";
                    return `I'm sorry, I couldn't generate a response. Reason: ${reason}.`;
                }
            }
            
            // Baaki saare functions (addMessage, showError, etc.) bilkul same rahenge
            addMessage(content, sender) { this.hideTypingIndicator(); const messageDiv = document.createElement('div'); messageDiv.className = `message ${sender}`; const avatar = document.createElement('div'); avatar.className = 'message-avatar'; avatar.innerHTML = sender === 'user' ? '<i class="fa-solid fa-user"></i>' : '<i class="fa-solid fa-robot"></i>'; const messageContent = document.createElement('div'); messageContent.className = 'message-content'; if (sender === 'bot') { let formattedContent = content.replace(/&/g, "&").replace(/</g, "<").replace(/>/g, ">"); formattedContent = formattedContent.replace(/```([\s\S]*?)```/g, (match, p1) => `<pre>${p1.trim()}</pre>`); formattedContent = formattedContent.replace(/`([^`]+)`/g, '<code>$1</code>'); formattedContent = formattedContent.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); formattedContent = formattedContent.replace(/\*(.*?)\*/g, '<em>$1</em>'); formattedContent = formattedContent.replace(/\n/g, '<br>'); messageContent.innerHTML = formattedContent; } else { messageContent.textContent = content; } if (sender === 'user') { messageDiv.appendChild(messageContent); messageDiv.appendChild(avatar); } else { messageDiv.appendChild(avatar); messageDiv.appendChild(messageContent); } this.chatMessages.appendChild(messageDiv); this.scrollToBottom(); }
            showError(message) { const errorDiv = document.createElement('div'); errorDiv.className = 'error-message'; errorDiv.innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i> ${message}`; this.chatMessages.appendChild(errorDiv); this.scrollToBottom(); }
            setLoading(loading) { this.isLoading = loading; this.sendButton.disabled = loading; this.messageInput.disabled = loading; if (loading) { this.sendButton.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>'; this.showTypingIndicator(); } else { this.sendButton.innerHTML = '<i class="fa-solid fa-paper-plane"></i>'; this.hideTypingIndicator(); } }
            showTypingIndicator() { const typingDiv = document.createElement('div'); typingDiv.className = 'message bot'; typingDiv.id = 'typingIndicator'; const avatar = document.createElement('div'); avatar.className = 'message-avatar'; avatar.innerHTML = '<i class="fa-solid fa-robot"></i>'; const content = document.createElement('div'); content.className = 'message-content'; content.innerHTML = `<div class="loading-dots"><div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div></div>`; typingDiv.appendChild(avatar); typingDiv.appendChild(content); this.chatMessages.appendChild(typingDiv); this.scrollToBottom(); }
            hideTypingIndicator() { const typingIndicator = document.getElementById('typingIndicator'); if (typingIndicator) { typingIndicator.remove(); } }
            scrollToBottom() { this.chatMessages.scrollTop = this.chatMessages.scrollHeight; }
            clearChat() { this.chatMessages.innerHTML = `<div class="info-message"><strong>Chat cleared!</strong><br>Start a new conversation below.</div>`; this.conversationHistory = []; }
        }

        new GeminiChat();
    </script>
</body>
</html>
